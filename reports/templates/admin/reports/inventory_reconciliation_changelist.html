{% extends "admin/base_site.html" %}
{% load static %}

{% block title %}Inventory Reconciliation{% endblock %}

{% block content %}
<div class="app-inventory-reconciliation">
    <h1>Inventory Reconciliation</h1>

    {% if no_entity_message %}
        <p style="color: red; font-weight: bold;">{{ no_entity_message }}</p>
    {% else %}

        <p>
            <a class="button" href="{% url download_url_name %}">
                Download CSV
            </a>
        </p>

        <div style="max-width: 100%; overflow-x: auto;">
            <table class="admin-inventory-report" style="border-collapse: collapse; min-width: 1200px;">
                <thead>
                    <tr>
                        <th style="border-bottom:1px solid #999; padding:4px;">Item #</th>
                        <th style="border-bottom:1px solid #999; padding:4px;">Name</th>
                        <th style="border-bottom:1px solid #999; padding:4px;">SKU</th>
                        <th style="border-bottom:1px solid #999; padding:4px;">UoM</th>

                        <th style="border-bottom:1px solid #999; padding:4px;">Model Qty Recv</th>
                        <th style="border-bottom:1px solid #999; padding:4px;">Model $ Recv</th>
                        <th style="border-bottom:1px solid #999; padding:4px;">Model Avg Cost</th>

                        <th style="border-bottom:1px solid #999; padding:4px;">Txn Qty Recv</th>
                        <th style="border-bottom:1px solid #999; padding:4px;">Txn Cost Recv</th>

                        <th style="border-bottom:1px solid #999; padding:4px;">Qty Sold</th>
                        <th style="border-bottom:1px solid #999; padding:4px;">Revenue Sold</th>

                        <th style="border-bottom:1px solid #999; padding:4px;">Qty On Hand</th>
                        <th style="border-bottom:1px solid #999; padding:4px;">Avg Cost (Txn)</th>
                        <th style="border-bottom:1px solid #999; padding:4px;">Value On Hand</th>

                        <th style="border-bottom:1px solid #999; padding:4px; color:#900;">Δ Qty Recv</th>
                        <th style="border-bottom:1px solid #999; padding:4px; color:#900;">Δ $ Recv</th>
                    </tr>
                </thead>
                <tbody>
                    {% for row in rows %}
                        <tr>
                            <td style="border-bottom:1px solid #ddd; padding:4px;">{{ row.item_number }}</td>
                            <td style="border-bottom:1px solid #ddd; padding:4px;">{{ row.item_name }}</td>
                            <td style="border-bottom:1px solid #ddd; padding:4px;">{{ row.sku }}</td>
                            <td style="border-bottom:1px solid #ddd; padding:4px;">{{ row.uom }}</td>

                            <td style="border-bottom:1px solid #ddd; padding:4px; text-align:right;">
                                {{ row.inventory_received_model }}
                            </td>
                            <td style="border-bottom:1px solid #ddd; padding:4px; text-align:right;">
                                {{ row.inventory_received_value_model }}
                            </td>
                            <td style="border-bottom:1px solid #ddd; padding:4px; text-align:right;">
                                {{ row.avg_cost_model }}
                            </td>

                            <td style="border-bottom:1px solid #ddd; padding:4px; text-align:right;">
                                {{ row.qty_received_txn }}
                            </td>
                            <td style="border-bottom:1px solid #ddd; padding:4px; text-align:right;">
                                {{ row.cost_received_txn }}
                            </td>

                            <td style="border-bottom:1px solid #ddd; padding:4px; text-align:right;">
                                {{ row.qty_sold_txn }}
                            </td>
                            <td style="border-bottom:1px solid #ddd; padding:4px; text-align:right;">
                                {{ row.revenue_sold_txn }}
                            </td>

                            <td style="border-bottom:1px solid #ddd; padding:4px; text-align:right;">
                                {{ row.qty_onhand_txn }}
                            </td>
                            <td style="border-bottom:1px solid #ddd; padding:4px; text-align:right;">
                                {{ row.avg_cost_txn }}
                            </td>
                            <td style="border-bottom:1px solid #ddd; padding:4px; text-align:right;">
                                {{ row.value_onhand_txn }}
                            </td>

                            {# highlight deltas if not zero #}
                            <td style="border-bottom:1px solid #ddd; padding:4px; text-align:right;
                                       {% if row.delta_received_qty != 0 %}color:#900; font-weight:bold;{% endif %}">
                                {{ row.delta_received_qty }}
                            </td>
                            <td style="border-bottom:1px solid #ddd; padding:4px; text-align:right;
                                       {% if row.delta_received_value != 0 %}color:#900; font-weight:bold;{% endif %}">
                                {{ row.delta_received_value }}
                            </td>
                        </tr>
                    {% empty %}
                        <tr>
                            <td colspan="16" style="padding:12px; text-align:center; color:#666;">
                                No items found for this entity.
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <p style="margin-top:1rem; color:#666; font-size:0.9rem;">
            Δ columns (delta) = Transaction math minus ItemModel snapshot.<br>
            If those numbers aren't zero, that's why invoicing says "0 available."
        </p>

    {% endif %}
</div>
{% endblock %}
